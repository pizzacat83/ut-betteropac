# UT-BetterOPAC

東京大学OPACをより便利にするChrome拡張機能です。

## 機能
- 自動ログイン
- 借りた本を自動延長
- お気に入り本の在架状況確認ページ

## 今後作るかもしれない機能
- シリーズ予約
- 予約の予約
- この本を生協で買うボタン
- ポップアップ画面

## 使い方
[ブログ記事（準備中）]()を参照

## 不具合
[Issues](https://github.com/pizzacat83/ut-betteropac/issues)を参照

## スマートフォン用ブックマークレット

<a href='javascript: void(function(){var a=new XMLHttpRequest();a.open(&quot;GET&quot;,&quot;https://opac.dl.itc.u-tokyo.ac.jp/opac/myopac/bookmark/add/?&quot;+&quot;bmname=&quot;+encodeURIComponent($(&quot;input[name=&#039;h_trd&#039;]&quot;).val())+&quot;&amp;bibid=&quot;+document.location.toString().match(/&amp;bibid=([0-9]+)/)[1]+&quot;&amp;ctkey=&amp;reqCode=insert&quot;,false);a.send();if(a.status==200&amp;&amp;a.responseText)alert(&quot;%E7%99%BB%E9%8C%B2%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82&quot;)}());'>OPACお気に入り登録</a><br>
<a href='javascript:void(function(){var o=&#039;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot; /&gt;&lt;title&gt;お気に入り&lt;/title&gt;&lt;/head&gt;&lt;body style=&quot;font-family: sans-serif;&quot;&gt;&lt;h1&gt;お気に入り&lt;/h1&gt;図書館を選択：&lt;select id=&quot;library&quot; style:&quot;border: 1px #ccc; border-radius:5px;&quot;&gt;&lt;/select&gt;&lt;button id=&quot;apply&quot;&gt;適用&lt;/button&gt;&lt;table id=&quot;favorites-table&quot;&gt;&lt;tr&gt;&lt;th&gt;資料名&lt;/th&gt;&lt;th colspan=&quot;2&quot;&gt;状態&lt;/th&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;&#039;;document.write(o);var p=[];function getConditions(a){var b=new XMLHttpRequest();b.open(&quot;GET&quot;,&quot;https://opac.dl.itc.u-tokyo.ac.jp/opac/opac_details/?bibid=&quot;+a,false);b.send();var c=(new DOMParser()).parseFromString(b.responseText,&quot;text/html&quot;);var d=c.getElementById(&quot;cantable&quot;).getElementsByClassName(&quot;hold-area&quot;)[0].children;var e=[];for(var f of d){var g=$(f).children(&quot;span&quot;).text().replace(&quot;キャンパス&quot;,&quot;&quot;);var h=$.map($(f).find(&quot;td.hold_detail_1:contains(&#039;配架場所&#039;)&quot;).next(),(x)=&gt;{return x.innerText.replace(/・.*/,&quot;&quot;).trim()});var j=$.map($(f).find(&quot;[id^=blstat_detail_BL]&quot;),(x)=&gt;{return x.id.match(/BL[0-9]+/)[0]});var k={};for(var i=0;i&lt;j.length;++i){b.open(&quot;GET&quot;,&quot;https://opac.dl.itc.u-tokyo.ac.jp/opac/opac_blstat/?phasecd=50&amp;bbcd=1&amp;blipkey=&quot;+j[i],false);b.send();var l=b.responseText.replace(/[([].*/,&quot;&quot;);l=l?l:&quot;在架&quot;;if(k[l])k[l].push(h[i]);else k[l]=[h[i]]}var m=[];for(var n in k){m.push({condition:n,locations:k[n]})}e.push({campus:g,conditions:m})}return e}function getFavorites(){var a=new XMLHttpRequest();a.open(&quot;GET&quot;,&quot;https://opac.dl.itc.u-tokyo.ac.jp/opac/myopac/bookmark/&quot;,false);a.send();var b=(new DOMParser()).parseFromString(a.responseText,&quot;text/html&quot;);var c=[];for(s of b.getElementsByTagName(&quot;li&quot;)){var d=[].filter.call(s.getElementsByTagName(&quot;a&quot;),(y)=&gt;{return y.href.search(&quot;javascript&quot;)!=0})[0].href.match(/\/([0-9]+)\//)[1];var e=[].filter.call(s.getElementsByTagName(&quot;input&quot;),(x)=&gt;{return x.name==&quot;label&quot;})[0].value;c.push({&quot;name&quot;:e,&quot;bibid&quot;:d})}return c}function getLibraryList(){var a=new XMLHttpRequest();a.open(&quot;GET&quot;,&quot;https://opac.dl.itc.u-tokyo.ac.jp/opac/opac_search/&quot;,false);a.send();var b=(new DOMParser()).parseFromString(a.responseText,&quot;text/html&quot;);return new Set([].map.call(b.getElementsByName(&quot;place_exp&quot;)[0],(x)=&gt;{return x.text.replace(/・.*/,&quot;&quot;)}))}var q=getLibraryList();for(var r of q){$(&quot;#library&quot;).append($(&quot;&lt;option&gt;&lt;/option&gt;&quot;).text(r).val(r))}p=[];var _=0;for(var s of getFavorites()){var t=getConditions(s.bibid);function sortFunc(x,y){if(x.condition==&quot;在架&quot;){return false}if(y.condition==&quot;在架&quot;){return true}return x.condition&gt;y.condition}var u=new Set(t.map((z)=&gt;{return z.conditions.filter((y)=&gt;{return y.condition==&quot;在架&quot;}).map((x)=&gt;{return x.locations}).reduce((x,y)=&gt;{return x.concat(y)},[])}).reduce((x,y)=&gt;{return x.concat(y)},[]));var v=t.length;var w=&quot;book-&quot;+_;for(var i=0;i&lt;v;++i){var A=$(&quot;&lt;tr&gt;&lt;/tr&gt;&quot;).addClass(w);if(i===0)A.append($(&quot;&lt;td&gt;&lt;/td&gt;&quot;).text(s.name).attr({rowspan:v}));A.append($(&quot;&lt;th&gt;&lt;/th&gt;&quot;).text(t[i].campus).css(&quot;white-space&quot;,&quot;nowrap&quot;));t[i].conditions=t[i].conditions.sort(sortFunc);var B=t[i].conditions.map((x)=&gt;{return x.condition+&quot;: &quot;+x.locations.join(&quot; &quot;)}).join(&quot;&lt;br&gt;&quot;);A.append($(&quot;&lt;td&gt;&lt;/td&gt;&quot;).html(B));$(&quot;#favorites-table&quot;).append(A)}p.push({query:w,available:u});++_}function highlight(){var a=$(&quot;#library&quot;).val();localStorage[&quot;library&quot;]=a;for(var b of p){if(b.available.has(a)){$(&quot;.&quot;+b.query).css(&quot;background-color&quot;,&quot;#bbddbb&quot;)}else{$(&quot;.&quot;+b.query).css(&quot;background-color&quot;,&quot;#fff&quot;)}}}$(&quot;body&quot;).css(&quot;font-family&quot;,&quot;sans-serif&quot;);$(&quot;table&quot;).css({&quot;border&quot;:&quot;1px solid #ccc&quot;,&quot;border-collapse&quot;:&quot;collapse&quot;,&quot;font-size&quot;:&quot;0.6em&quot;});$(&quot;th&quot;).css(&quot;border&quot;,&quot;1px solid #ccc&quot;);$(&quot;td&quot;).css(&quot;border&quot;,&quot;1px solid #ccc&quot;);$(&quot;button&quot;).css({&quot;border&quot;:&quot;1px solid #ccc&quot;,&quot;border-radius&quot;:&quot;3px&quot;,&quot;background-color&quot;:&quot;#f8f8f8&quot;});$(&quot;select&quot;).css({&quot;border&quot;:&quot;1px solid #ccc&quot;,&quot;border-radius&quot;:&quot;3px&quot;,&quot;background-color&quot;:&quot;#fff&quot;});$(&quot;#apply&quot;).click(highlight);if(localStorage[&quot;library&quot;]){$(&quot;#library&quot;).val(localStorage[&quot;library&quot;]);highlight()}}());'>OPACお気に入り一覧</a>
